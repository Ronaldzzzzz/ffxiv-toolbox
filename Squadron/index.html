<!DOCTYPE html>
<html lang="zh-TW" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 ÂÜíÈö™ËÄÖÂàÜÈöäË®àÁÆóÂô®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="style.css">
    <script src="squadron_data.js"></script>
    <script src="squadron_calc.js"></script>
</head>

<body
    class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 min-h-screen font-sans selection:bg-blue-500 selection:text-white flex flex-col">

    <nav class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-md transition-colors">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 dark:text-yellow-500 flex items-center gap-2">
                <span data-i18n="title">FF14 ÂÜíÈö™ËÄÖÂàÜÈöäË®àÁÆóÂô®</span> <span
                    class="text-xs px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 ml-2 border border-blue-200 dark:border-blue-700">V2.2</span>
            </h1>
            <div class="flex items-center gap-4">
                <a href="../index.html"
                    class="text-sm text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors flex items-center gap-1">
                    <span data-i18n="nav_home">ÂõûÈ¶ñÈ†Å</span>
                </a>
                <div
                    class="flex space-x-1 bg-slate-100 dark:bg-slate-900 p-0.5 rounded border border-slate-300 dark:border-slate-700">
                    <button onclick="changeLanguage('zh-TW')"
                        class="px-2 py-0.5 text-xs rounded opacity-50 hover:opacity-100 transition-opacity"
                        id="lang-tw">ÁπÅ</button>
                    <button onclick="changeLanguage('zh-CN')"
                        class="px-2 py-0.5 text-xs rounded opacity-50 hover:opacity-100 transition-opacity"
                        id="lang-cn">ÁÆÄ</button>
                    <button onclick="changeLanguage('ja')"
                        class="px-2 py-0.5 text-xs rounded opacity-50 hover:opacity-100 transition-opacity"
                        id="lang-ja">Êó•</button>
                    <button onclick="changeLanguage('en')"
                        class="px-2 py-0.5 text-xs rounded opacity-50 hover:opacity-100 transition-opacity"
                        id="lang-en">EN</button>
                </div>
                <button id="theme-toggle" onclick="toggleTheme()"
                    class="border border-slate-300 dark:border-slate-600 text-slate-500 dark:text-slate-400 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    üåô
                </button>
            </div>
        </div>
    </nav>
    <div class="max-w-7xl mx-auto p-6 w-full flex-grow">

        <div
            class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 mb-8 transition-colors">
            <h2 class="text-lg font-bold mb-4 text-slate-800 dark:text-slate-200 border-b border-slate-200 dark:border-slate-700 pb-2"
                data-i18n="section_1_title">
                1. ‰ªªÂãôÈúÄÊ±Ç & ÂàÜÈöäÁãÄÊÖã</h2>

            <div
                class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg mb-6 border border-slate-200 dark:border-slate-700 flex flex-wrap gap-4 items-end justify-center">
                <div class="flex flex-col items-center">
                    <label for="rank-selector" class="mb-1 font-bold text-sm" data-i18n="rank_label">ÂàÜÈöäÁ≠âÁ¥ö (Rank)</label>
                    <select id="rank-selector" onchange="updateRankCap()"
                        class="p-2 rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 w-[200px]">
                        <option value="1">Rank 1 (Max 200)</option>
                        <option value="2">Rank 2 (Max 280)</option>
                        <option value="3" selected>Rank 3 (Max 400)</option>
                    </select>
                </div>
                <div
                    class="text-xs text-slate-500 dark:text-slate-400 pl-4 border-l border-slate-300 dark:border-slate-700">
                    <div class="mb-1"><span data-i18n="pool_cap_label">Ë®ìÁ∑¥Â±¨ÊÄßÊ±†‰∏äÈôê:</span> <span id="pool-cap-display"
                            class="font-bold text-blue-600 dark:text-yellow-500 text-lg">400</span></div>
                    <div><span data-i18n="current_sum_label">ÁõÆÂâçËº∏ÂÖ•Á∏ΩÂíå:</span> <span id="current-sum-display"
                            class="font-mono">400</span></div>
                    <div id="sum-warning" class="text-red-500 font-bold mt-1 hidden" data-i18n="sum_warning">‚ö†Ô∏è Á∏ΩÂíå‰∏çÁ¨¶ÔºåË´ã‰øÆÊ≠£
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <p class="text-center mb-2 font-bold text-slate-600 dark:text-slate-400"
                        data-i18n="current_stats_title">ÁõÆÂâçË®ìÁ∑¥Êï∏ÂÄº (Training Stats)</p>
                    <div class="flex justify-center gap-4">
                        <div class="flex flex-col items-center">
                            <label class="font-bold text-sm stat-phy mb-1" data-i18n="stat_p">P</label>
                            <input type="number" id="curr-p" value="140" oninput="validateSum()"
                                onchange="saveSquadronData()"
                                class="w-20 p-2 text-center border rounded bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="font-bold text-sm stat-men mb-1" data-i18n="stat_m">M</label>
                            <input type="number" id="curr-m" value="140" oninput="validateSum()"
                                onchange="saveSquadronData()"
                                class="w-20 p-2 text-center border rounded bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="font-bold text-sm stat-tac mb-1" data-i18n="stat_t">T</label>
                            <input type="number" id="curr-t" value="120" oninput="validateSum()"
                                onchange="saveSquadronData()"
                                class="w-20 p-2 text-center border rounded bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-center mb-2 font-bold text-slate-600 dark:text-slate-400"
                        data-i18n="mission_req_title">‰ªªÂãôÈúÄÊ±Ç (Mission Requirements)
                    </p>
                    <div class="flex justify-center gap-4">
                        <div class="flex flex-col items-center">
                            <label class="font-bold text-sm stat-phy mb-1" data-i18n="stat_p">P</label>
                            <input type="number" id="req-p" value="315"
                                class="w-20 p-2 text-center border rounded bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="font-bold text-sm stat-men mb-1" data-i18n="stat_m">M</label>
                            <input type="number" id="req-m" value="325"
                                class="w-20 p-2 text-center border rounded bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="font-bold text-sm stat-tac mb-1" data-i18n="stat_t">T</label>
                            <input type="number" id="req-t" value="340"
                                class="w-20 p-2 text-center border rounded bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 mb-8 transition-colors">
            <div class="flex justify-between items-center mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">
                <h2 class="text-lg font-bold text-slate-800 dark:text-slate-200" data-i18n="section_2_title">2. ÂàÜÈöäÊàêÂì°
                    (8‰∫∫)</h2>
                <div class="flex gap-2">
                    <button onclick="saveSquadronData()"
                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors flex items-center gap-1 shadow-sm">
                        <span>üíæ</span> <span data-i18n="btn_save">Save</span>
                    </button>
                    <button onclick="loadSquadronData()"
                        class="px-3 py-1 bg-slate-600 hover:bg-slate-700 text-white text-xs rounded transition-colors flex items-center gap-1 shadow-sm">
                        <span>üìÇ</span> <span data-i18n="btn_load">Load</span>
                    </button>
                    <div class="w-px h-6 bg-slate-300 dark:bg-slate-600 mx-1"></div>
                    <button onclick="openExportModal()"
                        class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors flex items-center gap-1 shadow-sm">
                        <span>üì§</span> <span data-i18n="btn_export">Export</span>
                    </button>
                    <button onclick="openImportModal()"
                        class="px-3 py-1 bg-teal-600 hover:bg-teal-700 text-white text-xs rounded transition-colors flex items-center gap-1 shadow-sm">
                        <span>üì•</span> <span data-i18n="btn_import">Import</span>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="roster-container"></div>
        </div>

        <button id="calc-btn"
            class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-all transform active:scale-95 text-lg mb-8"
            onclick="calculate()" data-i18n="calc_btn">Ë®àÁÆóÊúÄ‰Ω≥ÈÖçÁΩÆ</button>

        <div class="bg-orange-50 dark:bg-orange-900/10 p-6 rounded-xl shadow-lg border-2 border-orange-200 dark:border-orange-500/30 hidden transition-colors"
            id="result-section">
            <h2 class="text-lg font-bold mb-4 text-orange-800 dark:text-orange-200" data-i18n="result_title">Ë®àÁÆóÁµêÊûú</h2>
            <div id="result-content"></div>
        </div>
    </div>

    <footer
        class="mt-8 py-6 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 text-center text-slate-500 dark:text-slate-600 text-[10px] md:text-xs leading-relaxed transition-colors">
        <p>FINAL FANTASY XIV ¬© 2010 - 2026 SQUARE ENIX CO., LTD. ÁâàÊ¨äÊâÄÊúâ„ÄÇ</p>
        <p>FINAL FANTASY is a registered trademark of Square Enix Holdings Co., Ltd.</p>
        <p class="mt-2 text-[10px]">
            <span>ÂèÉËÄÉË≥áÊñô‰æÜÊ∫ê:</span>
            <a href="https://ffxiv.consolegameswiki.com/wiki/Adventurer_Squadrons" target="_blank"
                rel="noopener noreferrer" class="text-blue-500 dark:text-blue-400 hover:underline">FF14 Console Games
                Wiki</a>
            |
            <a href="https://ffxivsquadron.com/" target="_blank" rel="noopener noreferrer"
                class="text-blue-500 dark:text-blue-400 hover:underline">
                FF14 Squadron</a>
            |
            <a href="https://ff14.huijiwiki.com/wiki/%E5%86%92%E9%99%A9%E8%80%85%E5%88%86%E9%98%9F" target="_blank"
                rel="noopener noreferrer" class="text-blue-500 dark:text-blue-400 hover:underline">
                Huiji Wiki</a>
            |
            <a href="https://cafemaker.wakingsands.com/" target="_blank" rel="noopener noreferrer"
                class="text-blue-500 dark:text-blue-400 hover:underline">
                Cafemaker</a>
            |
            <a href="https://xivapi.com/" target="_blank" rel="noopener noreferrer"
                class="text-blue-500 dark:text-blue-400 hover:underline">
                XIVAPI</a>
        </p>
    </footer>

    <!-- Recruit Selection Modal -->
    <div id="recruit-modal"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[80vh] flex flex-col border border-slate-200 dark:border-slate-700">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-lg dark:text-white" data-i18n="modal_title">ÈÅ∏ÊìáÈöäÂì°</h3>
                <button class="text-2xl text-slate-400 hover:text-slate-900 dark:hover:text-white"
                    onclick="closeRecruitModal()">&times;</button>
            </div>
            <div id="recruit-list-container" class="p-4 overflow-y-auto flex-grow">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- Data Import/Export Modal -->
    <div id="data-modal"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl flex flex-col border border-slate-200 dark:border-slate-700">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-lg dark:text-white" data-i18n="modal_data_title">Â∞èÈöäË≥áÊñô</h3>
                <button class="text-2xl text-slate-400 hover:text-slate-900 dark:hover:text-white"
                    onclick="closeDataModal()">&times;</button>
            </div>
            <div class="p-4 flex flex-col gap-4">
                <textarea id="data-textarea"
                    class="w-full h-64 p-3 font-mono text-xs border border-slate-300 dark:border-slate-600 rounded bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 resize-none focus:ring-2 focus:ring-blue-500 outline-none"
                    placeholder="JSON Data..."></textarea>

                <div class="flex justify-end gap-2" id="export-actions">
                    <button onclick="copyToClipboard()"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded shadow-sm transition-colors flex items-center gap-2">
                        <span>üìã</span> <span data-i18n="btn_copy">Ë§áË£ΩÂÖßÂÆπ</span>
                    </button>
                </div>

                <div class="flex justify-end gap-2 hidden" id="import-actions">
                    <button onclick="processImport()"
                        class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded shadow-sm transition-colors flex items-center gap-2">
                        <span>üì•</span> <span data-i18n="btn_import_confirm">Á¢∫Ë™çÂåØÂÖ•</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>



    <script>
        // --- Toast Notification Logic ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            // Styles based on type
            let borderColor = 'border-blue-500';
            let icon = '‚ÑπÔ∏è';

            if (type === 'success') {
                borderColor = 'border-green-500';
                icon = '‚úÖ';
            } else if (type === 'error') {
                borderColor = 'border-red-500';
                icon = '‚ùå';
            }

            toast.className = `bg-white dark:bg-slate-700 text-slate-800 dark:text-white px-4 py-3 rounded shadow-xl border-l-4 ${borderColor} flex items-center gap-3 transform transition-all duration-300 translate-y-2 opacity-0 min-w-[200px]`;
            toast.innerHTML = `
                <span class="text-lg">${icon}</span>
                <span class="text-sm font-medium">${message}</span>
            `;

            container.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
            });

            // Auto Dismiss
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // --- Language Logic ---
        let currentLang = localStorage.getItem('ffxiv-squadron-lang') || 'zh-TW';

        window.changeLanguage = function (lang) {
            currentLang = lang;
            localStorage.setItem('ffxiv-squadron-lang', lang);
            updateLanguage();

            // Re-render roster to update names/jobs - REMOVED to prevent data loss
            // initRoster(); -> This wipes data. updateLanguage now handles in-place updates.
            // Re-calculate if results are shown to update result text
            if (document.getElementById('result-section').style.display === 'block') {
                calculate();
            }
        }

        window.updateLanguage = function () {
            const t = TRANSLATIONS[currentLang] || TRANSLATIONS['zh-TW'];

            // Update static elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });

            // Update language buttons state
            document.querySelectorAll('[id^="lang-"]').forEach(btn => {
                if (btn.id === `lang-${currentLang.toLowerCase().replace('zh-', '')}`) {
                    btn.classList.remove('opacity-50');
                    btn.classList.add('opacity-100', 'font-bold', 'ring-1', 'ring-blue-500');

                    // Re-update recruit names in inputs if language changes (simple refresh of values)
                    for (let i = 0; i < 8; i++) {
                        const input = document.getElementById(`name-${i}`);
                        const initial = input.dataset.recruitId;
                        if (initial && TRANSLATIONS[currentLang].recruit_names && TRANSLATIONS[currentLang].recruit_names[initial]) {
                            input.value = TRANSLATIONS[currentLang].recruit_names[initial];
                        }

                        // Update Class Text
                        const clsInput = document.getElementById(`class-${i}`);
                        const cls = clsInput.value;
                        if (cls && TRANSLATIONS[currentLang].class_names) {
                            document.getElementById(`class-text-${i}`).innerText = TRANSLATIONS[currentLang].class_names[cls] || cls;
                        }
                        updateStatsDisplay(i); // Refresh stats labels
                    }

                } else {
                    btn.classList.add('opacity-50');
                    btn.classList.remove('opacity-100', 'font-bold', 'ring-1', 'ring-blue-500');
                }
            });

            // Update inputs placeholder/title if needed
            document.querySelectorAll('input[id^="name-"]').forEach(input => {
                input.placeholder = t.placeholder_select || 'ÈÅ∏ÊìáÈöäÂì°...';
            });
        }

        // --- UI Logic ---
        function updateRankCap() {
            const rank = parseInt(document.getElementById('rank-selector').value);
            const cap = RANK_CAPS[rank];
            document.getElementById('pool-cap-display').innerText = cap;
            validateSum();
        }

        function setInputs(p, m, t) {
            document.getElementById('curr-p').value = p;
            document.getElementById('curr-m').value = m;
            document.getElementById('curr-t').value = t;
        }

        function validateSum() {
            const t = TRANSLATIONS[currentLang] || TRANSLATIONS['zh-TW'];
            const rank = parseInt(document.getElementById('rank-selector').value);
            const cap = RANK_CAPS[rank];
            const p = parseInt(document.getElementById('curr-p').value) || 0;
            const m = parseInt(document.getElementById('curr-m').value) || 0;
            const tVal = parseInt(document.getElementById('curr-t').value) || 0;
            const sum = p + m + tVal;
            document.getElementById('current-sum-display').innerText = sum;
            const warning = document.getElementById('sum-warning');
            if (sum !== cap) {
                warning.style.display = 'block';
                // ‰ΩøÁî®ÁøªË≠ØÊñáÂ≠ó + Êï∏ÂÄºÈ°ØÁ§∫ÔºåÁ¢∫‰øùÂ§öË™ûË®ÄÁõ∏ÂÆπ
                warning.innerText = t.sum_warning + ` (${sum}/${cap})`;
                return false;
            } else {
                warning.style.display = 'none';
                return true;
            }
        }

        // --- Roster Initialization ---
        const rosterContainer = document.getElementById('roster-container');
        const defaultRecruits = [];

        // Save/Load Logic
        const CLASS_MAP_EXPORT = {
            'GLA': 'gladiator', 'MRD': 'marauder', 'CNJ': 'conjurer',
            'THM': 'thaumaturge', 'ACN': 'arcanist', 'LNC': 'lancer',
            'PGL': 'pugilist', 'ROG': 'rogue', 'ARC': 'archer'
        };
        const CLASS_MAP_IMPORT = Object.fromEntries(Object.entries(CLASS_MAP_EXPORT).map(([k, v]) => [v, k]));

        // Âæû Cap ÂèçÊü• RankÔºà‰æõÂåØÂÖ•ÊôÇ‰ΩøÁî®Ôºâ
        function getRankByCap(cap) {
            return Object.entries(RANK_CAPS).find(([_, v]) => v === cap)?.[0];
        }

        function getSquadronDataObj() {
            const recruits = {};
            for (let i = 0; i < 8; i++) {
                const isActive = document.getElementById(`active-${i}`).checked;
                const name = document.getElementById(`name-${i}`).dataset.recruitId || document.getElementById(`name-${i}`).value;
                const cls = document.getElementById(`class-${i}`).value;
                const lvl = parseInt(document.getElementById(`lvl-${i}`).value) || 1;
                const rData = RECRUIT_DATA.find(r => r.name === name) || {};

                recruits[(i + 1).toString()] = {
                    "used": isActive,
                    "class": CLASS_MAP_EXPORT[cls] || cls.toLowerCase(),
                    "level": lvl,
                    "race": (rData.race || "Unknown").toLowerCase(),
                    "name": name,
                    "exp": 0,
                    "chemistry": ["none", 0, "none", false, 0] // Default placeholders as we don't track chemistry yet
                };
            }

            const currTrain = [
                parseInt(document.getElementById('curr-p').value) || 0,
                parseInt(document.getElementById('curr-m').value) || 0,
                parseInt(document.getElementById('curr-t').value) || 0
            ];

            const rankVal = parseInt(document.getElementById('rank-selector').value);
            const rankCap = RANK_CAPS[rankVal] || 400;

            return {
                "recruits": recruits,
                "training": currTrain,
                "rank": rankCap
            };
        }

        function saveSquadronData() {
            const data = getSquadronDataObj();
            const jsonStr = JSON.stringify(data);
            localStorage.setItem('ffxiv_squad_data', jsonStr);
            showToast(TRANSLATIONS[currentLang]?.msg_saved || "Squadron data saved!", "success");
            console.log("Saved JSON:", jsonStr);
        }

        // Export/Import Modal Logic
        function openExportModal() {
            const data = getSquadronDataObj();
            const jsonStr = JSON.stringify(data); // Minified JSON
            document.getElementById('data-textarea').value = jsonStr;
            document.getElementById('data-textarea').readOnly = true;

            document.getElementById('export-actions').classList.remove('hidden');
            document.getElementById('import-actions').classList.add('hidden');

            document.getElementById('data-modal').style.display = 'flex';
        }

        function openImportModal() {
            document.getElementById('data-textarea').value = '';
            document.getElementById('data-textarea').readOnly = false;

            document.getElementById('export-actions').classList.add('hidden');
            document.getElementById('import-actions').classList.remove('hidden');

            document.getElementById('data-modal').style.display = 'flex';
            document.getElementById('data-textarea').focus();
        }

        function closeDataModal() {
            document.getElementById('data-modal').style.display = 'none';
        }

        function copyToClipboard() {
            const textarea = document.getElementById('data-textarea');
            textarea.select();
            document.execCommand('copy'); // Legacy but reliable, or use navigator.clipboard

            const btn = document.querySelector('#export-actions button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚úÖ</span> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        function processImport() {
            const jsonStr = document.getElementById('data-textarea').value;
            try {
                const data = JSON.parse(jsonStr);

                loadSquadronData(false, data);
                saveSquadronData(); // ÂåØÂÖ•ÂæåËá™ÂãïÂÑ≤Â≠òËá≥Êú¨Ê©ü
                closeDataModal();
            } catch (e) {
                showToast("Invalid JSON format!", "error");
                console.error(e);
            }
        }

        function loadSquadronData(silent = false, dataObj = null) {
            let data = dataObj;

            if (!data) {
                const jsonStr = localStorage.getItem('ffxiv_squad_data');
                if (!jsonStr) {
                    if (!silent) console.log("No saved data found.");
                    if (!silent) showToast("No saved data found.", "info");
                    return;
                }
                try {
                    data = JSON.parse(jsonStr);
                } catch (e) {
                    console.error("Failed to parse saved data:", e);
                    if (!silent) showToast("Failed to load saved data", "error");
                    return;
                }
            }

            try {
                console.log("Loading data:", data);

                // Load Rank
                const importedRank = getRankByCap(data.rank);
                if (data.rank && importedRank) {
                    document.getElementById('rank-selector').value = importedRank;
                    updateRankCap();
                }

                // Load Training
                if (data.training && Array.isArray(data.training) && data.training.length >= 3) {
                    setInputs(data.training[0], data.training[1], data.training[2]);
                    validateSum();
                }

                // Load Recruits
                if (data.recruits) {
                    for (let i = 0; i < 8; i++) {
                        const rec = data.recruits[(i + 1).toString()];
                        if (rec) {
                            // Name & Img selector logic
                            const name = rec.name;
                            const rData = RECRUIT_DATA.find(r => r.name === name); // Try exact match first

                            // Emulate selection
                            const nameInput = document.getElementById(`name-${i}`);
                            if (nameInput) {
                                nameInput.value = (TRANSLATIONS[currentLang]?.recruit_names?.[name]) || name;
                                nameInput.setAttribute('data-recruit-id', name);

                                // Update Image
                                if (rData) {
                                    const headerDiv = nameInput.parentElement.previousElementSibling;
                                    headerDiv.innerHTML = `<img src="${rData.img}" class="w-full h-full object-cover">`;
                                } else {
                                    // Fallback for custom name or unknown
                                    const headerDiv = nameInput.parentElement.previousElementSibling;
                                    headerDiv.innerHTML = `<span id="initials-${i}" class="font-bold text-slate-500 dark:text-slate-300">${name.substring(0, 2)}</span>`;
                                }

                                // Class
                                const clsKey = CLASS_MAP_IMPORT[rec.class] || rec.class.toUpperCase(); // Fallback for direct matches
                                const clsInput = document.getElementById(`class-${i}`);
                                if (clsInput) {
                                    clsInput.value = clsKey; // Update hidden input
                                    // Update visual UI for class
                                    document.getElementById(`class-icon-${i}`).src = CLASS_ICONS[clsKey] || '';
                                    document.getElementById(`class-text-${i}`).innerText = (TRANSLATIONS[currentLang]?.class_names?.[clsKey]) || clsKey;
                                }

                                // Level
                                document.getElementById(`lvl-${i}`).value = rec.level;

                                // Active Status
                                const cb = document.getElementById(`active-${i}`);
                                cb.checked = rec.used;
                                toggleMember(i); // Update UI state
                                updateStatsDisplay(i); // Update stats
                            }
                        }
                    }
                }

                // Recalculate sum just in case
                validateSum();
                if (!silent) showToast(TRANSLATIONS[currentLang]?.msg_loaded || "Squadron data loaded!", "success");

            } catch (e) {
                console.error("Failed to load data:", e);
                if (!silent) showToast("Failed to load data", "error");
            }
        }

        function initRoster() {
            let html = '';
            for (let i = 0; i < 8; i++) {
                const def = defaultRecruits[i];
                const isDefined = !!def;

                const name = isDefined ? def.name : '';
                const cls = isDefined ? def.class : 'GLA';
                const lvl = isDefined ? def.level : 60;

                // Find data
                const rData = (isDefined && name) ? (RECRUIT_DATA.find(r => r.name === name) || { name: name, img: null, race: 'Unknown' }) : { name: '', img: null, race: 'Unknown' };

                html += `
            <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 flex flex-col gap-2 relative transition-all shadow-sm member-card ${!isDefined ? 'disabled' : ''}" id="card-${i}">
                <input type="checkbox" class="absolute top-2 right-2 w-5 h-5 cursor-pointer z-10 accent-blue-600 active-checkbox" id="active-${i}" ${isDefined ? 'checked' : ''} onchange="toggleMember(${i})">
                
                <div class="flex items-center gap-3 cursor-pointer p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors member-header" onclick="openRecruitModal(${i})" title="ÈªûÊìäÊõ¥ÊèõÈöäÂì°">
                    <div class="w-20 h-28 bg-slate-200 dark:bg-slate-600 rounded-md flex justify-center items-center overflow-hidden shrink-0 shadow-sm border border-slate-300 dark:border-slate-500">
                        ${rData.img ? `<img src="${rData.img}" class="w-full h-full object-cover">` : `<span id="initials-${i}" class="font-bold text-slate-500 dark:text-slate-300">${name.substring(0, 2)}</span>`}
                    </div>
                    <div class="flex-grow min-w-0">
                         <input type="text" id="name-${i}" value="${(isDefined && TRANSLATIONS[currentLang].recruit_names && TRANSLATIONS[currentLang].recruit_names[name]) || name}" data-recruit-id="${name}" readonly class="w-full bg-transparent border-none font-bold cursor-pointer text-slate-800 dark:text-slate-200 focus:ring-0 p-0 text-sm truncate" placeholder="${TRANSLATIONS[currentLang].placeholder_select || 'ÈÅ∏ÊìáÈöäÂì°...'}">
                    </div>
                    <span class="text-xs text-slate-400">‚ñº</span>
                </div>

                <div class="relative w-full" id="class-dd-container-${i}">
                    <input type="hidden" id="class-${i}" value="${cls}">
                    <button onclick="toggleClassDropdown(${i}, event)" id="class-btn-${i}" type="button" class="w-full p-1.5 text-sm border border-slate-300 dark:border-slate-600 rounded bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-100 flex items-center justify-between hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors" ${!isDefined ? 'disabled' : ''}>
                        <div class="flex items-center gap-2 truncate">
                            <img src="${CLASS_ICONS[cls] || ''}" class="w-5 h-5 shrink-0" id="class-icon-${i}">
                            <span id="class-text-${i}" class="truncate">${(TRANSLATIONS[currentLang].class_names && TRANSLATIONS[currentLang].class_names[cls]) || cls}</span>
                        </div>
                        <span class="text-xs text-slate-400 shrink-0">‚ñº</span>
                    </button>
                    <div id="class-dd-menu-${i}" class="hidden absolute top-full left-0 w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-md shadow-xl z-20 max-h-60 overflow-y-auto mt-1">
                        ${Object.keys(CLASS_LEVEL_STATS).map(k => `
                            <div onclick="selectClass(${i}, '${k}', event)" class="flex items-center gap-2 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer transition-colors border-b border-slate-100 dark:border-slate-700 last:border-0">
                                <img src="${CLASS_ICONS[k] || ''}" class="w-5 h-5 shrink-0">
                                <span class="text-slate-900 dark:text-slate-100 text-sm truncate">${(TRANSLATIONS[currentLang].class_names && TRANSLATIONS[currentLang].class_names[k]) || k}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="flex items-center justify-between text-sm">
                    <label class="font-bold text-slate-600 dark:text-slate-400" data-i18n="lvl_label">Lv:</label>
                    <input type="number" id="lvl-${i}" value="${lvl}" min="1" max="60" onchange="updateStatsDisplay(${i})" class="w-12 p-1 text-center border border-slate-300 dark:border-slate-600 rounded bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-100" ${!isDefined ? 'disabled' : ''}>
                </div>
                
                <div class="text-xs text-slate-500 dark:text-slate-400 font-mono mt-1" id="stats-display-${i}" style="${!isDefined ? 'opacity: 0.5;' : ''}">P:0 M:0 T:0</div>
            </div>
            `;
            }
            rosterContainer.innerHTML = html;

            // Post-render: Apply disabled state properly visually
            for (let i = 0; i < 8; i++) {
                // If not defined, card is disabled, let's ensure inputs are disabled (already set in HTML mostly)
                // But toggleMember logic might need to run to ensure everything is consistent
                toggleMember(i);
                updateStatsDisplay(i);
            }
            validateSum();
        }

        // Modal Logic
        let currentSlotIndex = -1;

        function openRecruitModal(index) {
            console.log("Opening modal for slot:", index);

            // Removed disabled check to allow selection

            currentSlotIndex = index;
            const modal = document.getElementById('recruit-modal');
            const container = document.getElementById('recruit-list-container');

            if (!modal || !container) {
                console.error("Modal or Container element not found!");
                return;
            }

            modal.style.display = 'flex';

            // Check if we need to render (or re-render for language change? better to clear and re-render if needed, but for now simple check)
            // Actually, we should clear it if language might have changed, but let's stick to simple first or just re-render always?
            // Re-rendering always is safer for language switches.

            console.log("Rendering recruit list by race...");
            try {
                // Group by race
                const races = {};
                RECRUIT_DATA.forEach(r => {
                    const race = r.race || 'Unknown';
                    if (!races[race]) races[race] = [];
                    races[race].push(r);
                });

                let html = '';
                const t = TRANSLATIONS[currentLang];

                // Sort races alphabetically
                Object.keys(races).sort().forEach(race => {
                    const raceName = (t.race_names && t.race_names[race]) || race;
                    html += `<div class="bg-slate-100 dark:bg-slate-700 p-2 font-bold sticky top-0 border-l-4 border-blue-500 z-10 text-slate-800 dark:text-slate-200 mb-2">${raceName}</div>`;
                    html += `<div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 mb-4">`;
                    html += races[race].map(r => `
                    <div class="border border-slate-200 dark:border-slate-700 rounded p-2 text-center cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-500 transition-all bg-white dark:bg-slate-800 recruit-option flex flex-col items-center" data-name="${r.name.replace(/"/g, '&quot;')}">
                        <div class="w-20 h-28 mx-auto mb-1 relative bg-slate-200 dark:bg-slate-700 rounded-md overflow-hidden shadow-sm border border-slate-300 dark:border-slate-600">
                            <img src="${r.img}" alt="${r.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
                            <div class="absolute inset-0 flex items-center justify-center font-bold text-slate-500 hidden recruit-fallback">${r.name.substring(0, 2)}</div>
                        </div>
                        <div class="text-xs font-bold text-slate-800 dark:text-slate-200 truncate">${(t.recruit_names && t.recruit_names[r.name]) || r.name}</div>
                    </div>
                `).join('');
                    html += `</div>`;
                });

                container.innerHTML = html;

                // Add event listener for delegation if not duplicated (container innerHTML cleared so OK)
                container.onclick = function (event) {
                    const option = event.target.closest('.recruit-option');
                    if (option) {
                        const name = option.getAttribute('data-name');
                        console.log("Selected:", name);
                        selectRecruit(name);
                        saveSquadronData();
                    }
                };
            } catch (e) {
                console.error("Error rendering list:", e);
                container.innerHTML = `<div style="color:red; padding:20px;">Error rendering list: ${e.message}</div>`;
            }
        }

        function closeRecruitModal() {
            document.getElementById('recruit-modal').style.display = 'none';
            currentSlotIndex = -1;
        }

        window.selectRecruit = function (name) {
            if (currentSlotIndex === -1) return;

            // Auto-enable if disabled
            const cb = document.getElementById(`active-${currentSlotIndex}`);
            if (cb && !cb.checked) {
                cb.checked = true;
                toggleMember(currentSlotIndex);
            }

            const rData = RECRUIT_DATA.find(r => r.name === name);
            if (!rData) return;

            const t = TRANSLATIONS[currentLang] || TRANSLATIONS['zh-TW'];

            // Update UI
            const nameInput = document.getElementById(`name-${currentSlotIndex}`);
            nameInput.value = (t.recruit_names && t.recruit_names[name]) || name;
            nameInput.setAttribute('data-recruit-id', name);

            // Update Header Image
            const headerDiv = nameInput.parentElement.previousElementSibling;
            headerDiv.innerHTML = `<img src="${rData.img}" class="w-full h-full object-cover">`;

            closeRecruitModal();
        }


        // Custom Class Dropdown Logic
        let activeDropdownIndex = -1;

        window.toggleClassDropdown = function (index, e) {
            e = e || window.event;
            // Close others
            if (activeDropdownIndex !== -1 && activeDropdownIndex !== index) {
                const prevMenu = document.getElementById(`class-dd-menu-${activeDropdownIndex}`);
                if (prevMenu) prevMenu.classList.add('hidden');
            }

            const menu = document.getElementById(`class-dd-menu-${index}`);
            if (menu) {
                if (menu.classList.contains('hidden')) {
                    menu.classList.remove('hidden');
                    activeDropdownIndex = index;
                } else {
                    menu.classList.add('hidden');
                    activeDropdownIndex = -1;
                }
            }

            // Prevent event bubbling to window click
            if (e && e.stopPropagation) {
                e.stopPropagation();
            } else if (e) {
                e.cancelBubble = true;
            }
        }

        window.selectClass = function (index, clsKey, e) {
            if (e) e.stopPropagation();
            // Update value
            document.getElementById(`class-${index}`).value = clsKey;

            // Update UI
            document.getElementById(`class-icon-${index}`).src = CLASS_ICONS[clsKey];
            const t = TRANSLATIONS[currentLang] || TRANSLATIONS['zh-TW'];
            document.getElementById(`class-text-${index}`).innerText = (t.class_names && t.class_names[clsKey]) || clsKey;

            // Close menu
            document.getElementById(`class-dd-menu-${index}`).classList.add('hidden');
            activeDropdownIndex = -1;

            // Update stats
            updateStatsDisplay(index);
        }

        // Global click to close dropdowns
        window.onclick = function (event) {
            const modal = document.getElementById('recruit-modal');
            const dataModal = document.getElementById('data-modal');

            if (event.target == modal) {
                closeRecruitModal();
            }
            if (event.target == dataModal) {
                closeDataModal();
            }

            if (activeDropdownIndex !== -1) {
                // If click is outside the active dropdown container
                if (!event.target.closest(`#class-dd-container-${activeDropdownIndex}`)) {
                    document.getElementById(`class-dd-menu-${activeDropdownIndex}`).classList.add('hidden');
                    activeDropdownIndex = -1;
                }
            }
        }

        window.toggleMember = function (index) {
            const checkbox = document.getElementById(`active-${index}`);
            const card = document.getElementById(`card-${index}`);
            const inputs = card.querySelectorAll('select, input:not(.active-checkbox), button');

            if (checkbox.checked) {
                card.classList.remove('disabled');
                inputs.forEach(el => el.disabled = false);
            } else {
                card.classList.add('disabled');
                inputs.forEach(el => el.disabled = true);
            }
        }

        function getStats(clsKey, level) {
            const stats = CLASS_LEVEL_STATS[clsKey];
            if (!stats) return [0, 0, 0];

            // Ensure level is within bounds (1-60)
            let safeLevel = Math.max(1, Math.min(60, level));

            // Lookup exact value
            if (stats[safeLevel]) {
                return stats[safeLevel];
            }
            return [0, 0, 0];
        }

        window.updateStatsDisplay = function (index) {
            const t = TRANSLATIONS[currentLang] || TRANSLATIONS['zh-TW'];
            const cls = document.getElementById(`class-${index}`).value;
            const lvl = parseInt(document.getElementById(`lvl-${index}`).value) || 1;
            const s = getStats(cls, lvl);
            document.getElementById(`stats-display-${index}`).innerHTML =
                `<span class="stat-phy">${t.stat_p}:${s[0]}</span> <span class="stat-men">${t.stat_m}:${s[1]}</span> <span class="stat-tac">${t.stat_t}:${s[2]}</span>`;
        }

        // --- Calculation Logic ---
        // ÁßªËá≥ squadron_calc.js

        initRoster();

        // Theme Logic
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('ffxiv-tools-theme', 'light');
                document.getElementById('theme-toggle').innerText = 'üåô';
            } else {
                html.classList.add('dark');
                localStorage.setItem('ffxiv-tools-theme', 'dark');
                document.getElementById('theme-toggle').innerText = '‚òÄÔ∏è';
            }
        }

        // Init Theme
        (function () {
            const savedTheme = localStorage.getItem('ffxiv-tools-theme');
            if (savedTheme === 'dark' || !savedTheme) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle').innerText = '‚òÄÔ∏è';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-toggle').innerText = 'üåô';
            }

            // Init Language
            const langSelect = document.getElementById('lang-selector');
            if (langSelect) {
                langSelect.value = currentLang;
            }
            updateLanguage();

            // Auto-load if exists
            const saved = localStorage.getItem('ffxiv_squad_data');
            if (saved) {
                loadSquadronData(true);
            }
        })();
    </script>


</body>

</html>